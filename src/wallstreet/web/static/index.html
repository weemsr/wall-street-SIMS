<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wall Street War Room</title>
  <link rel="stylesheet" href="/static/xterm.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: #0a0a0a; color: #e0e0e0; font-family: 'Courier New', monospace; height: 100%; width: 100%; }
    #setup { display: flex; align-items: center; justify-content: center; height: 100%; }
    #setup.hidden { display: none; }
    .setup-box { background: #1a1a2e; border: 1px solid #16213e; border-radius: 8px; padding: 2rem 2.5rem; width: 360px; }
    .setup-box h1 { font-size: 1.4rem; color: #00ff88; margin-bottom: 0.3rem; }
    .setup-box p.sub { font-size: 0.8rem; color: #888; margin-bottom: 1.5rem; }
    .setup-box label { display: block; font-size: 0.85rem; margin-bottom: 0.3rem; color: #aaa; }
    .setup-box input, .setup-box select { width: 100%; padding: 0.5rem; margin-bottom: 1rem; background: #0f3460; border: 1px solid #1a1a4e; color: #e0e0e0; border-radius: 4px; font-family: inherit; font-size: 0.9rem; }
    .setup-box button { width: 100%; padding: 0.6rem; background: #00ff88; color: #0a0a0a; border: none; border-radius: 4px; font-weight: bold; font-size: 1rem; cursor: pointer; font-family: inherit; }
    .setup-box button:hover { background: #00cc6a; }
    #terminal-container { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    #terminal-container.active { display: block; }
  </style>
</head>
<body>
  <div id="setup">
    <div class="setup-box">
      <h1>WALL STREET WAR ROOM</h1>
      <p class="sub">Portfolio Management Roguelike</p>
      <label for="name">Player Name</label>
      <input type="text" id="name" value="Player" maxlength="20" />
      <label for="weeks">Season Length</label>
      <select id="weeks">
        <option value="3">1 quarter (Quick Play)</option>
        <option value="6">2 quarters</option>
        <option value="9">3 quarters</option>
        <option value="12">4 quarters (1 year)</option>
        <option value="24" selected>8 quarters (Full Season)</option>
      </select>
      <label for="capital">Starting Capital</label>
      <input type="text" id="capital" value="1,000,000" />
      <label for="seed">Seed (blank = random)</label>
      <input type="text" id="seed" placeholder="random" />
      <button id="start-btn">START GAME</button>
    </div>
  </div>
  <div id="terminal-container"></div>

  <script src="/static/xterm.js"></script>
  <script src="/static/addon-fit.js"></script>
  <script>
    document.getElementById('start-btn').addEventListener('click', function() {
      try {
        var name = document.getElementById('name').value.trim() || 'Player';
        var weeks = document.getElementById('weeks').value;
        var capitalRaw = document.getElementById('capital').value.replace(/,/g, '').trim();
        var capital = parseInt(capitalRaw, 10) || 1000000;
        var seedInput = document.getElementById('seed').value.trim();
        var seed = seedInput ? parseInt(seedInput, 10) : Math.floor(Math.random() * 4294967296);

        // Hide setup, show terminal
        document.getElementById('setup').style.display = 'none';
        var termEl = document.getElementById('terminal-container');
        termEl.style.display = 'block';

        // Create terminal
        var term = new Terminal({
          cursorBlink: true,
          fontSize: 14,
          fontFamily: "'Courier New', monospace",
          theme: { background: '#0a0a0a', foreground: '#e0e0e0', cursor: '#00ff88' },
          convertEol: true,
          scrollback: 5000,
        });

        term.open(termEl);

        // Fit addon
        try {
          if (window.FitAddon) {
            var fa = window.FitAddon.FitAddon ? new window.FitAddon.FitAddon() : new window.FitAddon();
            term.loadAddon(fa);
            fa.fit();
            window.addEventListener('resize', function() { try { fa.fit(); } catch(e){} });
          }
        } catch(e) {}

        term.write('Connecting...\r\n');

        // Connect WebSocket
        var proto = location.protocol === 'https:' ? 'wss' : 'ws';
        var wsUrl = proto + '://' + location.host + '/ws/play?name=' + encodeURIComponent(name) + '&weeks=' + weeks + '&seed=' + seed + '&capital=' + capital;
        term.write('URL: ' + wsUrl + '\r\n');

        var ws = new WebSocket(wsUrl);
        var inputBuffer = '';

        ws.onopen = function() {
          term.write('\x1b[1;32mConnected to Wall Street War Room\x1b[0m\r\n\r\n');
          // Keepalive ping every 30s to prevent proxy idle timeout
          setInterval(function() {
            if (ws.readyState === WebSocket.OPEN) {
              ws.send('');
            }
          }, 30000);
        };
        ws.onmessage = function(event) { term.write(event.data); };
        ws.onclose = function(e) { term.write('\r\n\x1b[1;33mConnection closed (code=' + e.code + '). Refresh to play again.\x1b[0m\r\n'); };
        ws.onerror = function(e) { term.write('\r\n\x1b[1;31mWebSocket error.\x1b[0m\r\n'); };

        term.onData(function(data) {
          if (ws.readyState !== WebSocket.OPEN) return;
          for (var i = 0; i < data.length; i++) {
            var ch = data[i];
            if (ch === '\r' || ch === '\n') {
              term.write('\r\n');
              ws.send(inputBuffer);
              inputBuffer = '';
            } else if (ch === '\x7f' || ch === '\b') {
              if (inputBuffer.length > 0) { inputBuffer = inputBuffer.slice(0, -1); term.write('\b \b'); }
            } else if (ch >= ' ') {
              inputBuffer += ch;
              term.write(ch);
            }
          }
        });

        term.focus();
      } catch(e) {
        document.body.style.color = '#ff4444';
        document.body.style.padding = '2rem';
        document.body.innerText = 'ERROR: ' + e.message + '\n\n' + e.stack;
      }
    });
  </script>
</body>
</html>
